"""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""
" Name: .vimrc (see _vimrc for MS Windows)
" Author: Travis Goldie
" Date: January 2012
"""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""
"""" Core
filetype plugin indent on
set background=dark
set completeopt=longest,menuone
set autoread

" Set tabs and spaces handling
set shiftwidth=4
set tabstop=4
set expandtab

" Add Mouse Support
set mouse=a
set mousemodel=popup_setpos

" Enable modeline
set modeline

" Turn on line numbers, set to width, and set color of the line numbers
set number
set numberwidth=2
highlight LineNr ctermfg=Blue
" Use relative counting
"set relativenumber

" set ignorecase smartcase, case-insensitive searching
set ignorecase

" Fix to get Alt key shortcut to work. Maps Escape chars
" to their Alt combinations. For uppercase letters do the
" same except use 'Z'.
let myChar='a'
while myChar <= 'z'
    exec "set <A-".myChar.">=\e".myChar
    exec "imap \e".myChar." <A-".myChar.">"
    let myChar = nr2char(1 + char2nr(myChar))
endw

" Performance improvements
set ttyfast " got a fast terminal
set ttyscroll=3
set lazyredraw " to avoid scrolling problems

" Timeout is to tell difference between Meta encoding and hitting 2 keys
set timeout
set timeoutlen=3000
set ttimeoutlen=100

" Makes backspace work more natually
fixdel
set backspace=indent,eol,start

" Default keybinding is Ctrl-^
" Insert and command-line mode Caps Lock.
" Lock search keymap to be the same as insert mode.
set imsearch=-1

" Load the keymap that acts like capslock.
set keymap=insert-only_capslock

" Turn it off by default.
set iminsert=0

" Enable iternal version of matchit
runtime! macros/matchit.vim

"""" Import External Config Files
" XXX Plugins should always be sourced in first
source ~/.vimrc.plugins
" XXX Done with Plugins

source ~/.vimrc.config
source ~/.vimrc.funcs
source ~/.vimrc.js

syntax on


"""" Files
" Auto set working dir to current file
set autochdir

" An alternative to the option
"autocmd BufEnter * silent! lcd %:p:h

" Handle using vim on MS Windows
if has("win32") || has("win16")
    let $VIMBACKUP='c:\Users\tgoldie\Dropbox\shared\backup\vimbackup'
endif

"Check to see if dir exists. otherwise use current dir
if !isdirectory( "$VIMBACKUP" )
	:silent !mkdir -p $VIMBACKUP >/dev/null 2>&1
	" :!mkdir -p $VIMBACKUP
endif

" where to put backup files
set backupdir=$VIMBACKUP

" directory to place swap files in
set directory=$VIMBACKUP
set backup

" share system clipboard by default
set clipboard=unnamedplus

" support both, in this order
set fileformats=unix,dos


"""" Map Keys
inoremap jj <Esc>
noremap ; :

" Invert the comment on the current line
"inoremap qq <Esc>:execute "normal \<Leader>ci"<CR>

" Leave insert mode when VIM looses keyboard focus
autocmd FocusLost,TabLeave,WinLeave,WinEnter * stopinsert

" Gets full path to file by default
verbose noremap <leader>g1 <C-g>

" If the current buffer has never been saved, it will have no name,
" call the file browser to save it, otherwise just save it.
command! -nargs=0 -bar Update if &modified
                           \|    if empty(bufname('%'))
                           \|        browse confirm write
                           \|    else
                           \|        confirm write
                           \|    endif
                           \|endif

" Save using ctrl-S. WOOT! If in insert mode return to it.
nnoremap <C-s> :<C-u>Update<CR>
inoremap <C-s> <Esc>:Update<CR>
"inoremap <silent> <C-s> <C-o>:Update<CR>

" Make diffs easier
verbose map <C-Up> [c
verbose map <C-Down> ]c

" Surround keymappings
verbose nmap K `[v`]

"verbose nnoremap cof :set <C-R>=<SID><CR><CR>


""""" Syntax
"highlight Comment ctermfg=green
highlight OverLength ctermbg=red ctermfg=white guibg=#592929


"""" Folding
set foldenable " Turn on folding
set foldmethod=syntax
"set foldmarker={,} " Fold C style code (only use this as default
                   "" if you use a high foldlevel)
"set foldmethod=marker " Fold on the marker
"set foldmethod=indent
set foldlevel=12
" what movements open folds
set foldopen=block,hor,mark,percent,quickfix,tag



" Enable omni completion.
" Autocompleting tags - http://tdewolf.blogspot.com/2013/05/the-mighty-vim.html
autocmd FileType c set omnifunc=ccomplete#Complete
autocmd FileType css setlocal omnifunc=csscomplete#CompleteCSS
autocmd FileType html,markdown setlocal omnifunc=htmlcomplete#CompleteTags
autocmd FileType javascript setlocal omnifunc=javascriptcomplete#CompleteJS
autocmd FileType php set omnifunc=phpcomplete#CompletePHP
autocmd FileType python setlocal omnifunc=pythoncomplete#Complete
autocmd FileType vim setlocal omnifunc=vimcomplete#CompleteTags
autocmd FileType xml setlocal omnifunc=xmlcomplete#CompleteTags


"""" Movement
" Move by row rather than line. Useful for wrapped lines.
nnoremap j gj
nnoremap k gk

" <space> now works like a browser
"nnoremap <space> <C-d>
nnoremap <Space> <PageDown>
noremap <M-space> <PageUp>

" Move around windows
verbose nmap <C-h> <C-w>h
verbose nmap <C-j> <C-w>j
verbose nmap <C-k> <C-w>k
verbose nmap <C-l> <C-w>l

verbose nmap <C-right> <C-w>h
verbose nmap <C-left> <C-w>j
verbose nmap <C-down> <C-w>k
verbose nmap <C-up> <C-w>l

"""" Search
" Toggles highlighting search results in buffer
noremap <F4> :set hlsearch! hlsearch?<CR>

" Jumping lands on top or bottom of screen
verbose nnoremap n nzz
verbose nnoremap } }zz
set incsearch

"""" Status Line
set statusline=%9* " File type
set statusline+=\ %y " File type
set statusline+=\ (%P) " Percent of file
set statusline+=\ %c "Current Column
set statusline+=\:(\%l\/\%L) " Current line number / Total Lines
" set statusline+=\ %{FileSize()}
set statusline+=\ %F " Full file path
set statusline+=\ %m%=%{fugitive#statusline()} " Is file modified

" always show the status line
set laststatus=2

" Show some context while scrolling
set scrolloff=5

""" Spelling (Autocmds)
"autocmd BufNewFile,BufRead *.txt,*.md,README set spell
"autocmd BufNewFile,BufRead doc/*.txt set nospell
"autocmd BufNewFile,BufRead */doc/*.txt set nospell

"""" Tab Pages (window tabs) and Viewports
" Setting for tabline
set switchbuf=usetab
set showtabline=2
set tabpagemax=20

" Split buffer open to the bottom by default
set splitbelow

" When window open, make it equal size
set equalalways

" Create a new tab
verbose noremap <leader>t <Esc>:tabnew<CR>

" Change tags in either normal or insert mode
verbose noremap <A-left>   :tabp<cr>
verbose noremap <A-h>  :tabp<cr>
verbose imap <A-left>  <Esc>:tabp<cr>
verbose imap <A-h> <Esc>:tabp<cr>

verbose noremap <A-right>  :tabn<cr>
verbose noremap <A-l>  :tabn<cr>
verbose imap <A-right>  <Esc>:tabn<cr>
verbose imap <A-l> <Esc>:tabn<cr>

verbose map <A-]> :tab split<CR>:exec("tag ".expand("<cword>"))<CR>
verbose map <C-}> :vsp <CR>:exec("tag ".expand("<cword>"))<CR>

" In select mode, use \p to paste over selected text
" without loosing what is in registr
verbose xnoremap <leader>p "_dP

"""" Whitespace Trimming
function! TrimWhiteSpace()
    %s/\s\+$//e
endfunction
autocmd BufWritePre *.* :call TrimWhiteSpace()
"autocmd BufWritePre *.css,*.html,*.js,*.scss :call TrimWhiteSpace()
